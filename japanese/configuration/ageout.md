# データエージアウト

デフォルトでは、DatalaiQは決してデータを削除しません。そのため、ユーザは各ストレージウェルのポリシーを指定し、どのようにデータを移行および/または削除することができるかを記述する必要があります。エージアウトポリシーは、データの保持、ストレージウェルの使用、圧縮を制御します。 各ストレージ・ウェルは、ホット・ロケーションとオプションのコールド・ストレージ・ロケーションをサポートし、1つのストレージ・システムから他のストレージ・システムへのデータ移動方法を決定する一連のパラメータを備えています。理想的なDatalaiQストレージ・アーキテクチャは、「ホット」ストレージ用の比較的小さな高速ストレージ・プールと、長期的な「コールド」ストレージに使用する大容量/低コストのストレージ・プールで構成されています。 NVMEベースのフラッシュドライブやXポイントドライブはホットストアに最適で、磁気RAIDアレイ、NAS、SANプールはコールドプールに適しています。

ウェル内のストレージの単位は**シャード**で、約1.5日（2<sup>17</sup>秒）分のデータを表します。アクティブシャード**は、現在の時刻のエントリーを受信しているシャードである。2<sup>17</sup>秒ごとに、新しいアクティブシャードが作成され、前のアクティブシャードはエージアウトの対象となります。エージアウトは常にシャード全体に影響する。このため、最も厳しいエージアウトポリシーを適用した場合でも、各ウェルには約1.5日分のデータに対して十分なスペースが必要です。ストレージの上限を1GBと指定し、1時間に10GBのデータを1つのシャードに取り込んだ場合、アクティブなシャードがエージアウ トされるまで、そのウェルは10GBを占有することになります。エージアウト中も検索に支障はありませんし、インジェストにも支障はありません。

エージアウトポリシーは、以下の3つのパラメータで定義できます:

* Time
* Total Storage
* Storage Availability

時間ベースのパラメータを使用すると、ポリシー、契約上の合意、または法的要件を遵守するためにデータ保持ポリシーを指定することができます。例えば、企業ポリシーとして、Webプロキシログは30日以内に保存するように規定されている場合があります。

 total storageパラメータは、ウェルの保存上限を指定し、保存データ量が保存上限を超えた場合にのみ、データのエージアウトや廃棄を行うようDatalaiQに指示します。

ストレージの可用性パラメータは、DatalaiQに対して、少なくとも最小限の利用可能なストレージを維持し、必要に応じてデータをエージングしてスペースを解放するように指示します。 ストレージの可用性に関する制約は、DatalaiQがデバイス上の空きストレージを使用できるようにしたいが、デバイスがある可用性の閾値を下回った場合にデータを破棄したい場合に便利です。

1つのウェルに複数の制約を追加することができます。例えば、合計が100GBを超えない限り、データを最大90日間保持するように指定することができます。

エージアウトシステムは、ホットプールからコールドプールへエントリーを転送する際に、データストレージを最適化するように設計されています。 最適化により、同じ時間範囲とタグのエントリーが局所化され、従来の回転ディスクのヘッド移動が減少します。 圧縮と組み合わせることで、最適化フェーズはコールドデータにおけるストレージ使用率と検索性能を大幅に向上させることができます。

エージアウトシステムは、古いデータを削除するように設定することができるため、ウェルのエージアウトを行う前に設定を吟味することが非常に重要である。

## 基本設定

各ウェルは常に `Location` ディレクティブで定義されたホットストレージの場所を持ちます。オプションとして、`Cold-Location`で定義されたコールドストレージの場所を持つことができます。エイジアウトは、制約を設定し、データをホットストレージからコールドストレージに、コールドストレージからアーカイブまたは削除に移動または削除するための任意のルールを定義することによって設定されます。削除ルールが明示的に指定されない限り、DatalaiQは決してデータを削除しないことに注意してください。デフォルトの設定にはエージアウトルールが含まれていますので、特定の保存要件がある場合は、設定ファイルを確認してください（また、カスタムウェルを設定することもできます）。

注意: エージアウトの構成は、各ウェル単位です。 各ウェルは、他のすべてのウェルとは独立して非同期的に動作します。 2つのウェルが同じボリュームを共有している場合、ストレージリザーブに基づくエージアウト指令を有効にすると、1つのウェルが他のウェルによって侵食されたために積極的にデータを移行または削除することになります。

備考: エージアウトが設定されているストレージシャードにデータがアクティブに流入している場合、またはクエリーがアクティブに行われている場合、エージアウトシステムはそのシャードのエージアウトを後日に延期します。

## ホット/コールド削除ルール

データがホットウェルからエイジングアウトすると、コールドウェルが定義されていればコールドウェルに移動します。コールドウェルが定義されていない場合、 `Delete-Cold-Data` オプションで明示的に削除が許可されていない限り、データはホットウェルに残されます。

同様に、データがコールドウェルから古くなった場合（「凍結」）、`Delete-Frozen-Data`パラメータが指定されない限り、削除されません。長期間のアーカイブが必要な場合、凍結したデータは削除する前に[DatalaiQアーカイブサービス](archive.md)に送ることができます。

これらのルールの例は、以下のセクションの設定スニペットで見ることができます。

注意: データをディスクから実際に削除したい場合は、 `Delete-Cold-Data` (ホットウェルのみを使用する場合) または `Delete-Frozen-Data` (ホットウェルとコールドウェルの両方を使用する場合) を **指定する必要があります**。これらの設定は、ユーザーからの明示的な承認を必要とします。なぜなら、我々の一般的なポリシーは、要求されない限り何も削除しないことだからです。ウェル設定に適切な削除パラメータを含めない場合、データは決して削除されず、ディスクは最終的に一杯になります!

## 時間ベースのアージアウトルール

時間ベースのエージアウトは、時間保持の要件に基づいてデータを管理する。 たとえば、ある組織では、すべてのログを90日間保存することが要求される場合があります。 時間ベースのエージアウト制約は、ポリシーおよび/または法的要件によってログの保持時間が決定されるデータプールで最もよく使用されます。 時間ベースのエージアウト期間は、次の大文字と小文字を区別しない略語を使用して、日単位と週単位で指定できます:

* "d"     - days
* "days"  - days
* "w"     - weeks
* "weeks" - weeks

備考: シャードがエージアウトされるのは、その*直近の*エントリーが継続時間を超えたときだけです。

ホットプールのデータのみを使用し、30日以上経過したデータを削除するウェル設定例:

```
[Storage-Well "syslog"]
	Location=/mnt/xpoint/gravwell/syslog
	Tags=pcap
	Hot-Duration=30D
	Delete-Cold-Data=true
```

7日後にホットプールからコールドプールに移動し、90日後にコールドプールからデータを削除する構成例:

```
[Storage-Well "syslog"]
	Location=/mnt/xpoint/gravwell/syslog
	Cold-Location=/mnt/storage/gravwell_cold/syslog
	Tags=pcap
	Hot-Duration=7D
	Cold-Duration=90D
	Delete-Frozen-Data=true
```

備考: 上記の構成では、ホットプールで7日間、コールドプールで90日間過ごした後、97日目になるとデータは永久に削除されます。

時間ベースのエージアウトは1日に1回起動され、エージアウト可能なシャードについて各プールを掃引します。 デフォルトでは、掃引はUTCの深夜に行われますが、実行時刻はウェルの設定で Ageout-Time-Override ディレクティブにより上書きすることができます。 オーバーライドディレクティブは、24時間UTC時間で指定されます。

エージアウト時間のチェックをUTCの午後7時に行うよう上書きした設定例:
```
[Storage-Well "syslog"]
	Location=/mnt/xpoint/gravwell/syslog
	Cold-Location=/mnt/storage/gravwell_cold/syslog
	Tags=syslog
	Tags=switchlogs
	Hot-Duration=7D
	Cold-Duration=90D
	Delete-Frozen-Data=true
	Ageout-Time-Override=19:00
```

## トータルストレージベースのエージアウトルール

トータルストレージ制約では、タイムスパンに関係なく、ボリューム内の特定のストレージ量を割り当てます。 ストレージ制約により、DatalaiQインデクサは、サイズが限られている（NVMEフラッシュなど）高速ストレージプールを積極的かつフルに活用することができるようになります。 インデクサは、ウェルが許容量を超えて消費していない限り、ストレージプールにエントリーを保持します。 ストレージの制約により、データストレージを中断することなく、予期せぬ取り込みのバーストを行うことができます。 たとえば、あるインデクサが1TBの高速フラッシュストレージを持ち、通常7日分のホットストレージを処理できるにもかかわらず、予期せぬデータイベントによって1日に600GBの取り込みが発生した場合、インデクサはホットプールの新しいデータ取り込み能力を中断させずに、古いデータをコールドプールにエージングアウトさせることが可能です。 シャードは時間によって優先され、ホットプールとコールドプールの両方で、最も古いシャードが最初にエージ アウトされます。

500GBまでのデータをホットプールに保持し、500GBを超えると古いデータを削除するウェル構成例:

```
[Storage-Well "windows"]
	Location=/mnt/xpoint/gravwell/windows
	Tags=windows
	Tags=sysmon
	Max-Hot-Storage-GB=500
	Delete-Cold-Data=true
```

ホットプールが約50GBを保持し、その後最大10TBを保持するコールドプールにエージングアウトするウェル構成例:

```
[Storage-Well "windows"]
	Location=/mnt/xpoint/gravwell/windows
	Cold-Location=/mnt/storage/gravwell_cold/windows
	Tags=windows
	Tags=sysmon
	Max-Hot-Storage-GB=50
	Max-Cold-Storage-GB=10000
	Delete-Frozen-Data=true
```

注意: ストレージベースの制約は、即座にハードな制限になるわけではありません。 ストレージの割り当てを超えたときに、インデクサがデータを取り込みながらエージアウ トできるように、少し余裕を持たせておく必要があります。 たとえば、ホットストレージデバイスが512GBを保持でき、システムが通常1日あたり100GBを取り込む場合、ストレージ制限を490GBに設定すれば、インデクサがデータを移行している間にホットプールが完全に満杯にならないよう、十分なヘッドルームを確保することができるはずです。

## ストレージの空き容量ベースのエージアウトルール

ウェルの貯蔵制約もまた、貯蔵の利用可能性に基づいて適用することができる。 一部のウェルは優先順位が低く、利用可能な場合にのみストレージを消費する場合があります。 ストレージリザーブ指令を使用すると、利用可能なストレージの一定割合がボリューム上に維持されている限り、ウェルが望むだけのスペースを消費することができます。 ストレージ利用可能性規則は、基本的にウェルが「二流」のウェルとして動作し、他の誰も利用しない場合にのみ ディスクスペースを消費することを可能にします。 Hot-Storage-Reserve=5` を指定すると、ホットストレージの空き容量が5%以下になった場合に、ウェルは最も古いシャードのマイグレーションまたは削除を開始します。 つまり、そのボリュームが他のウェルや他の任意のファイルストレージをホストしている場合、ウェルは必要に応じてストレージの使用量を削減することができるのです。

ボリュームに30%の空き容量があればホットロケーションを使用し、10%の空き容量があればコールドボリュームを使用するウェル構成例:

```
[Storage-Well "doorlogs"]
	Location=/mnt/xpoint/gravwell/doorlogs
	Cold-Location=/mnt/storage/gravwell_cold/doorlogs
	Tags=badgeaccess
	Hot-Storage-Reserve=30
	Cold-Storage-Reserve=10
	Delete-Frozen-Data=true
```

注意: ストレージ・リザーブドで動作するDatalaiQエージアウト・システムは、外部の影響と完全に直交して動作します。50%のストレージ上限を尊重するように設定されたウェルが、外部のアプリケーションによって60%のボリュームまで満たされると、DatalaiQはアクティブ・シャード外のすべてのエントリを削除します。 ストレージを予約して構成されたウェルは、消耗品として扱われるべきです。

## 注意点・重要事項

エイジアウト制約はシャード全体に適用されるため、1つのシャードがデータ制約のサイズを超えて成長した場合、シャードがアイドル状態になるとシャード全体がエイジアウトされます。

時間ベースの制約では、シャード全体が指定された時間ウィンドウの外になることが必要です。 そのため、1日未満の時間制約は意味を持たず、ホットプールは少なくとも2日分のデータを保持できる必要があります。

時間ベースの制約と総保存量制約を組み合わせる場合は注意が必要です。Hot-Duration=7D` と `Cold-Duration=90D` を指定した場合、97日後にデータが削除されます。しかし、`Max-Hot-Storage-GB=2` と `Cold-Duration=90D` を指定した場合、ホットウェルが2GBを超えるとデータはホットウェルからコールドウェルに移動し、**90日経過するとコールドウェルからデータが削除されます**。

### 透過的圧縮とDockerの注意点

[透過的圧縮](compression.md)は、総保存量に関わるエージアウトルールにとって重要な意味を持つ。透過的圧縮を有効にしたファイルは、非圧縮版よりも少ないディスク容量しか必要としないが、実際にどの程度のディスク容量を使っているかを正確に調べるのは難しい。Max-Hot-Storage-GB=5`で構成されたウェルを考えてみましょう。透過圧縮が有効な場合、非圧縮データのサイズが5GBに達したときではなく、*実際のディスクスペース*が5GB使われたときにのみデータをエージアウトすることが望ましいと言えます。

DatalaiQは、圧縮を有効にしたBTRFSシステム上のシャードの実際のディスク上のサイズを照会しようとします。一般的なLinuxシステムでは、これは問題なく動作します。しかし、**Dockerコンテナ**を使用する場合は、特別な注意を払う必要があります。Dockerのランタイムディレクトリ（デフォルトでは `/var/lib/docker` ）がBTRFSファイルシステム上にある場合、wellsは透過圧縮を使用できますが、 **特定のIOCTLコールがデフォルトで無効になっている**ので、オンディスクサイズのクエリーは失敗します。インデクサコンテナのインスタンス化に使用するコマンドに `--cap-add=SYS_ADMIN` フラグを渡すことで、Docker コンテナに適した IOCTL 呼び出しを有効にすることができます。

### 削除セーフティネット

エージアウトポリシーでは、データを **削除** することができます。 管理者は、ホットストレージとコールドストレージの両方のプールが要求されたエージアウト制約に対応できるように、構成とハードウェアリソースを吟味することが非常に重要です。 良好な構成では、削除は "Delete-X-Data" 命令（ホットプールでは `Delete-Cold-Data` 、コールドプールでは `Delete-Frozen-Data` ）によって明示的に承認される必要があります。

Delete-X-Dataディレクティブは、管理者が設定中にデータの削除について考えることを確実にするためのセーフティネットとして使用されます。 例えば、あるウェルがホットプール、コールドプールなし、ホットリテンション7日間と設定されている場合、DatalaiQはホットプールから7日以上前のデータを削除しようとする。 しかし、"Delete-Cold-Data=true "という設定ディレクティブがない場合、エージアウトシステムはデータを削除せず、代わりにログで文句を言い、実質的にエージアウトを無効とします。

コールドプールにも同じ指令要件があり、"Delete-Frozen-Data=true"指令が設定されていない限り、DatalaiQはコールドプールからエージアウトしたデータを削除しないことを意味します。 もし120日前のデータがホットプールに取り込まれ、コールドプールの保持設定が90日の場合、**Delete-Cold-Data指令がtrueに設定されている**と、エージアウトシステムはコールドプールを完全にバイパスしてデータを直接削除しますので、ご注意ください。

時間ベースのエージアウトは、データのエージングのタイミングを決定するためにシステムクロックに依存します。つまり、不適切なシステムクロックは、データのエージングのタイミングを早める原因となります。 管理者は、システムクロックが適切に保守されていること、NTPが使用されている場合は信頼できるソースであることを確認する必要があります。 もし攻撃者がDatalaiQインデクサーのシステム・クロックを妥当な期間コントロールすることができれば、エージ・アウトを引き起こすことができます。 時間はDatalaiQにおけるアンカーであり、ストレージ・プールと同じように強力に保護されなければなりません。


## エイジアウトルール インタラクション

エージアウト・ルールを積み重ねたり組み合わせたりすることで、ストレージ・リソースに対する強固な制御を実現することができます。 例えば、DatalaiQでは、ホットプールには高速ストレージの小規模プールを、コールドプールには低コストの大規模ディスクアレイを使用することを強く推奨しています。 ストレージの制約を組み合わせることで、データ保持のポリシーを守りながら、小さな高速プールを自由に利用することができます。

データのエージアウト制約は、先着順で互いに独立して動作します。 100GBのストレージ制約に加えて7日の時間制約がウェルに適用されている場合、シャードは7日またはプールが100GBを超えた時点で、どちらか早いほうにエージアウトされます。 ウェル内の1つのプールに複数の制約を組み合わせるのは便利ですが、過度に積極的なエージアウト構成は予期しない動作を引き起こす可能性があることに注意してください。 例えば、あるウェルのリテンションが7日間で、ホット・ストレージ・リザーブが5％である場合、DatalaiQは7日間のリテンションとは別に5％のリテンションを満たそうと試みます。 各エージアウト指令は完全に独立して動作し、リテンションサイズまたはストレージリザーブの設定は、時間ベースの指令を上書きすることができ、その逆も同様です。

最大100GBのホットストレージを使用し、90日間データを保持するウェル構成例:

```
[Storage-Well "weblogs"]
	Location=/mnt/xpoint/gravwell/web
	Cold-Location=/mnt/storage/gravwell_cold/web
	Tags=apache
	Tags=nginx
	Tags=iis
	Max-Hot-Data-GB=100
	Cold-Duration=90D
	Delete-Frozen-Data=true
```

30日間データを保持しつつ、ホットストレージに10％の空き容量を確保しようとするウェル構成例:

```
[Storage-Well "weblogs"]
	Location=/mnt/xpoint/gravwell/web
	Cold-Location=/mnt/storage/gravwell_cold/web
	Tags=apache
	Tags=nginx
	Tags=iis
	Hot-Storage-Reserve=10
	Cold-Duration=30D
	Delete-Frozen-Data=true
```

7日分または100GBをホットプールに保持し、20%が利用可能である限りすべてのデータをコールドプールに保持するウェル構成例:

```
[Storage-Well "weblogs"]
	Location=/mnt/xpoint/gravwell/web
	Cold-Location=/mnt/storage/gravwell_cold/web
	Tags=apache
	Tags=nginx
	Tags=iis
	Hot-Storage-Reserve=100
	Hot-Duration=7D
	Cold-Storage-Reserve=20
	Delete-Frozen-Data=true
```


