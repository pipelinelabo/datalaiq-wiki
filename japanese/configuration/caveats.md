# よくある問題点と注意点

DatalaiQを設定し、使用する過程で、いくつかの問題が発生する可能性があります。この文書では、最も一般的なものをいくつか取り上げています。

## クロックソース警告

KVMなどの仮想化環境でDatalaiQを実行すると、次のような通知が表示されることがあります:

```
遅い可能性のあるクロックソースacpi_pmが検出されました。ウェブサーバとインデクサを次のいずれかに変更することを検討してください: tsc, kvm-clock
```

DatalaiQは時間志向の強いシステムであるため、頻繁に現在の時刻を確認する必要があります。クロック・ソースの中には他のものより著しく遅いものがあり、DatalaiQのクエリーにおいて顕著な速度低下をもたらすことがある。

クロックソース警告を編集するには, [こちらの案内に従ってください](https://aws.amazon.com/premiumsupport/knowledge-center/manage-ec2-linux-clock-source/).

備考: クロックソースを変更できない場合、この通知はデフォルトの「admin」ユーザにのみ表示され、他のユーザには表示されないので、必要に応じて無視することができます。

## DatalaiQインターフェイスに到達できない

DatalaiQをインストールした後、WebブラウザがWebサーバーに到達できない、またはWebサーバーがどのインデクサにも接続されないという現象が発生することがあります。これは、ファイアウォールのポートが閉じていることが原因であることが多いようです。DatalaiQは、適切な動作のために開く必要がある多数のTCPポートを使用します。どのポートを開かなければならないかについての詳細は、[ネットワークに関する考察のページ](networking.md)を参照してください。

## HTTPSとセキュアリスナーを設定する

デフォルトでは、DatalaiQはTLS証明書を含まないか、または生成しません。インターネットやその他の信頼できないネットワークでDatalaiQを使用する予定がある場合、できるだけ早く証明書をインストールすることを強くお勧めします。手順については、[証明書ページ](certificates.md)を参照してください。

備考：DatalaiQは、TLS 1.2以降と互換性のある証明書を必要とします。

## DatalaiQのプロセスが起動しない

DatalaiQコンポーネント（Webサーバー、インデックス、サーチエージェント、インジェスターなど）の起動が拒否される理由はいくつかあります。

### 無効な設定

無効な設定ファイルは、通常、関連するコンポーネントの障害につながります。より詳しい情報を得るには、いくつかの場所を探すことができます。

* `dev/shm/` は通常、該当するプロセスの標準エラー出力を含みます。例えば、ウェブサーバコンポーネントは `/dev/shm/gravwell_webserver` に出力されます。
* `opt/gravwell/log` には、いくつかのコンポーネントからのログファイルが含まれています。
* 設定ミスの正確な性質に応じて、インジェスターはエラーや警告を `gravwell` タグに記録するかもしれません。

### 所有権に関する問題

DatalaiQコンポーネントは、ユーザー "gravwell "として実行されることを想定しています。ルートユーザーがDatalaiQコンポーネントを手動で実行すると、重要なファイルが作成または変更され、それらがルートに属しているものとしてマークされる可能性があります。後で "gravwell "アカウントで実行すると、そのプロセスはそのファイルにアクセスできなくなります。しかし、`/opt/gravwell/bin` を変更すると SELinux のフラグと衝突する可能性があるので、注意してください!

注意: DatalaiQのサポートから明確な指示がない限り、`/opt/gravwell/bin`にあるファイルのパーミッションや所有権を変更しないでください。

### SELinuxに関する問題

DatalaiQ は SELinux との互換性を保つために `/opt/gravwell` にあるファイルに適切なフラグを立てようとしますが、 `/opt/gravwell/bin` にある `chown` と `chmod` コマンドを不用意に使うと、これらのフラグをクリアしてしまうことがあります。より詳しい情報は [ハードニングのドキュメントのSELinuxのセクション](hardening.md) を参照してください。

## DatalaiQのメモリ/CPUの消費量が多すぎる

DatalaiQはしばしば膨大な量のデータを処理する必要があるため、メモリやCPUの消費量を制限することはありません。しかし、DatalaiQ を他の重要なソフトウェアと同じシステムで実行する必要がある場合は、リソースへのアクセスを制限することができます。その場合は、[システムハードニングドキュメント](hardening.md) の "systemd Unit Files" のセクションを参照してください。

## DatalaiQと仮想メモリ領域

DatalaiQ インデクサは、保存データにアクセスするためにメモリ・マップド・ファイル (mmap) を使用します。マッピングされたファイルはすべて、Linux カーネルによって規定された、インデクサーのメモリ・マップド・ファイルの最大数に対してカウントされます。シ ス テ ムに よ っ ては、 イ ンデ ッ ク サ内のデー タ の量 と 粒度に よ っ ては、 ク ラ ッ シ ュ を避け る ために メ モ リ マ ッ プ フ ァ イ ルの許容数を増や し なければな ら ない場合があ り ます。利用可能なメモリマップドファイルの数を使い果たすことによるクラッシュは、通常 `malloc` の失敗として表示されます。最近のLinuxディストリビューションでは、デフォルトのメモリマップドファイルの数は65536です。

許可されるメモリマップファイルの数を増やすには、`sysctl`を使用します:

```
sysctl -w vm.max_map_count=262144
```

メモリマップファイルの許容数を恒久的に変更するには、`sysctl`パラメータを `sysctl.conf` に追加してください:

```
echo vm.max_map_count=262144 >> /etc/sysctl.conf
```


