# 高度なDatalaiQ設定

この文書では、ストレージウェル、データエージアウト、マルチノードクラスターの構成に関する情報を含む、DatalaiQインストールに関するより高度な構成オプションについて説明します。

DatalaiQは、オプションで分散システムとして、DatalaiQクラスターを構成する複数のインデキサーを使用することができます。 デフォルトのインストールでは、ウェブサーバーとインデクサーの両方が同じマシンにインストールされますが、適切なライセンス設定を行えば、クラスタの実行は単一インスタンスの実行と同じくらいシンプルになります。

## インストーラーオプション

DatalaiQインストーラは、自動インストールやデプロイメントを容易にするために、いくつかのフラグをサポートしています。 以下のフラグがサポートされています。:

| Flag | Description |
|------|-------------|
| `--help` | インストーラーヘルプメニューを表示する |
| `--no-certs` | インストーラーが自己署名入り証明書を生成しない
| `--no-questions` | すべてのデフォルトを仮定し、自動的にEULAを受け入れる
| `--no-random-passwords` | ランダムなインジェスト・シークレットとコントロール・シークレットを生成しない
| `--no-indexer` | DatalaiQ インデクサーのコンポーネントをインストールしないでください。
| `--no-webserver` | DatalaiQ Webサーバーコンポーネントはインストールしないでください。
| `--no-searchagent` | DatalaiQ 検索エージェントをインストールしない (通常 `--no-webserver` と一緒に使用します)
| `--no-start` | インストール後、コンポーネントを起動しないでください
| `--no-crash-report` | 自動デバッグレポートコンポーネントをインストールしない
| `--use-config` | 特定のコンフィグファイルを使用する

### 高度なインストール要件に対応した共通のユースケース

DatalaiQを複数のインデクサを持つクラスターに展開する場合、インデクサノードにWebサーバーコンポーネントをインストールすることは望ましくありません。

自動デプロイメントツールを使用している場合、インストーラが停止して質問されるのは困ります。

インジェストとコントロールの共有シークレットを持つインデクサーのリストが既にある場合、インストール時に設定ファイルを指定することで処理を大幅にスピードアップできます。

例えば、Webサーバーのインストールやパスワードのランダム化を行わずにインデックスサーコンポーネントをインストールするには、次のように実行します:

```
root@gravserver# bash gravwell_installer.sh --no-questions --no-random-passwords --no-webserver
```

パスワードをランダムにすることを選択した場合、インデクサーとウェブサーバーに戻って、 `gravwell.conf` ファイル内の `Control-Auth` パラメータがウェブサーバーと各インデクサーで一致することを確認する必要があります。また、すべてのインデキサーで同じ `Ingest-Auth` 値を設定したいと思うでしょう。

## 一般的な設定

DatalaiQクラスタの設定は、最初からシンプルかつ効率的に行えるように設計されています。 しかし、非常に大規模なシステムや、メモリに制約のある小規模な組み込み機器や産業用機器をより有効に活用できるようにするためのツマミも用意されています。 コアとなる設定ファイルはウェブサーバーとインデクサーの両方で共有されるように設計されており、デフォルトでは `/opt/gravwell/etc/gravwell.conf` に配置されています。

設定オプションの詳細な一覧は、[このページ](parameters.md)を参照してください。

インデクサーの完全な設定例については、私たちの [デフォルト設定例](indexer-default-config.md) をご覧ください。

設定ファイルの中で最も重要な項目は、 `Ingest-Auth`, `Control-Auth`, `Search-Agent-Auth` の各設定パラメータです。 Control-Auth` パラメータは、ウェブサーバとインデクサが互いを認証するために使用する共有秘密です。攻撃者がインデクサと通信でき、かつ `Control-Auth` トークンを持っている場合、インデクサが保存しているデータに完全にアクセスすることができます。 Ingest-Auth` トークンは、インジェスターを認証するために使用され、タグを作成してデータをDatalaiQにプッシュする機能を制限します。 DatalaiQはスピードが自慢です。つまり、`Ingest-Auth`トークンにアクセスした攻撃者は、非常に短時間で膨大な量のデータをDatalaiQにプッシュすることができるのです。 Search-Agent-Auth` トークンを使用すると、DatalaiQ の Search Agent ユーティリティが自動的にウェブサーバーに接続し、ユーザーの代わりに検索を実行することができるようになります。これらのトークンは重要であり、慎重に保護する必要があります。

注意: DatalaiQのクラスタ構成では、適切な相互通信を可能にするために、すべてのノードに同じ `Ingest-Auth` と `Control-Auth` 値が設定されることが不可欠です。

## Webサーバー設定

ウェブサーバーは、すべての検索のフォーカスポイントとして機能し、DatalaiQへのインタラクティブなインターフェイスを提供します。 ウェブサーバーは大きなストレージを必要としませんが、非常に高速なストレージを小規模にプールしておくと、検索で大量のデータが返された場合でも、ユーザーが結果をすばやくナビゲートすることができるようになります。 ウェブサーバーは検索パイプラインにも参加し、データのフィルタリング、メタデータの抽出、レンダリングの一部を実行することがよくあります。 ウェブサーバーを導入する際には、適度な大きさのソリッドステートディスク（可能であればNVME）、16GB以上のメモリプール、および少なくとも4つの物理コアを推奨しています。 DatalaiQは極めて同時並行的に動作するように構築されているため、より多くのCPUコアと追加メモリを使用することで大きな性能上の利点が得られます。 Intel E5またはAMD Epycチップと32GB以上のメモリは良い選択であり、多ければ多いほど良いというものではありません。

2 つの設定オプションが、ウェブサーバーにインデクサーとの通信方法を伝えます。Remote-Indexers`オプションはインデクサーのIPまたはホスト名を指定し、 `Control-Auth`オプションはインデクサーの認証にウェブサーバーが使用する共有キーを指定します。3つのインデクサに接続するウェブサーバは、その `gravwell.conf` に次のように記述します:

```
Control-Auth=MySuperSecureControlToken
Remote-Indexers=net:10.0.1.1:9404
Remote-Indexers=net:10.0.1.2:9404
Remote-Indexers=net:10.0.1.3:9404
```

備考: 上記のインデクサは、デフォルトのポート9404で制御接続を待ち受けます。このポートは、インデクサーの DatalaiQ.conf ファイルにある `Control-Port` オプションで設定します。

### WebサーバーのTLS

デフォルトでは、DatalaiQはTLS証明書を生成しません。ウェブサーバーで適切に署名されたTLS証明書または自己署名証明書を設定する手順については、[TLS/HTTP説明書](certificates.md)を参照してください。
ウェブサーバー設定の落とし穴
### 

* リモートインデックスの欠落または誤設定
* Control-Authトークンの欠落または不一致
* ウェブサーバーとバックエンドのライセンスが不一致です。
  * ウェブサーバーとインデクサーの両方に互換性のあるライセンスが必要です。
* ウェブサーバーとインデクサーの間のネットワーク接続が悪い
  * 遅延が大きい、帯域が狭い、MTUサイズが誤って設定されている。
* ファイアウォールがインデックスサーバーやウェブサーバーのポートへのアクセスをブロックしている
  * デフォルトは9404

## インデクサー設定

Indexer は、DatalaiQ のストレージセンターであり、データの保存、検索、処理を担当します。 クエリを実行する際、インデクサはまずデータを見つけ、それを検索パイプラインに押し込むという、最初の力仕事を行います。 検索パイプラインは、効率化のためにインデクサーの上で可能な限り多くの作業を並行して行います。 インデクサは、高速で低レイテンシーのストレージと、可能な限りのRAMを使用することで利益を得ます。 DatalaiQはファイルシステムのキャッシュを利用することができるので、同じデータに対して複数のクエリーを実行しても、ディスクに移動する必要すらありません。 DatalaiQは、キャッシュされたデータに対して、ノードあたり5GB/s以上の速度で動作していることが確認されています。 メモリが多ければ多いほど、より多くのデータをキャッシュすることができます。 最大級のマシンでもメモリ容量を超えるような大きなプールを検索する場合、高速のRAIDアレイがスループットを向上させるのに役立ちます。

インデクサには、少なくとも 32GB のメモリと 8 つの CPU コアを搭載することを推奨します。 可能であれば、DatalaiQ は、ホットウェルとして機能する超高速 NVME ソリッドステートディスクも推奨します。これは、数日分の最新データを保持し、より低速の回転ディスクプールにエージングアウトします。 ホットウェルは、最新データへの高速アクセスを可能にする一方で、DatalaiQ が古いデータを整理・統合して、可能な限り効率的に検索できるようにするものです。

インデクサーのDatalaiQ.confには、その一般的な動作に影響を与えるいくつかの重要な設定オプションが存在します:

* `Control-Port` は、インデクサがウェブサーバからの接続をリッスンするポートを設定します。デフォルトは 9404 です。
* `Control-Auth` は、ウェブサーバーが認証に使用する共有秘密を設定します。デフォルトはランダムに生成される文字列です。
* `Ingest-Port`と `TLS-Ingest-Port`は、それぞれ暗号化されていないインジェストトラフィックと暗号化されたインジェストトラフィックに対してリッスンするポートを指定します。
* `Ingest-Auth` は、データインジェストがインデクサを認証するために使用する共有秘密を設定する。デフォルトはランダムに生成される文字列である。

インデクサはデータを_wells_に格納する。各ウェルには、ある程度の数のタグが格納されています。もし、1つのウェルに100GBの "pcap "とタグ付けされたデータと10MBの "syslog "とタグ付けされたデータがある場合、syslogデータを検索すると、インデクサはディスクからpcapデータも読まなければならず、検索速度が低下します。この理由から、多くのデータを含むと予想されるタグのために別のウェルを作成することを強くお勧めします。詳細については、「タグとウェル」セクションを参照してください。

## タグとウェル

**タグ**は、異なるタイプのデータを論理的に分離するための方法として使用されます。 タグはインジェスト時にインジェスター (SimpleRelay, NetworkCapture など) によって適用されます。 例えば、syslogログ、Apacheログ、ネットワークパケット、ビデオストリーム、オーディオストリームなどに一意のタグを適用すると便利です。 **ウェル**は、取り込まれたデータを実際に整理して保存するストレージのグループ化です。ユーザーは通常、ウェルと対話することはないが、ウェルはディスク上のデータを**シャード**に格納し、各シャードには約1.5日分のデータが格納される。

データストリームをより高速または大規模なストレージプールにルーティングできるように、ウェルにタグを割り当てることができます。たとえば、高帯域幅のリンクからのraw pcapストリームは、より高速なストレージプールに割り当てる必要がありますが、syslogやWebサーバーからの比較的低容量のログエントリは、高速なストレージを必要としない場合があります。タグとウェルのマッピングは、1対1のマッピングです。1つのウェルに複数のタグを含めることはできますが、1つのタグを複数のウェルに割り当てることはできません。 データストリームを論理的、物理的に分離することで、異なるデータに異なるルールを適用することができます。 例えば、ネットワークトラフィックのような高帯域幅のストリームは15日ごとに失効または圧縮し、低帯域幅のストリームはより長い期間保持することが望ましい場合があります。 論理的な分離は、システムがタグに基づいて適切なウェルにインテリジェントに問い合わせるため、検索性能も大幅に向上します（例えば、defaultというウェルにあるsyslogエントリーを検索する場合、DatalaiQは他のウェルに問い合わせません）。

タグからウェルへのマッピングは `/opt/gravwell/etc/gravwell.conf` 設定ファイルで定義されます。デフォルトでは、すべてのタグを受け入れる `Default-Well` のみが構成されます。複数のウェルにタグを関連付けるインデクサーの設定例は、以下のようになります:

```
[Default-Well]
	Location=/opt/gravwell/storage/default/

[storage-well "raw"]
	Location=/opt/gravwell/storage/raw/
	tags=pcap
	tags=video
```

そのため、"raw "という名前のついたデータは、"pcap "や "video "といったタグのついたデータの保存に使われ、かなりの量のストレージを消費すると推測される。


### タグの制限とその他制限事項

タグ名には英数字のみを使用できます。ダッシュ、アンダースコア、特殊文字などはタグ名には使用できません。 タグは、"syslog "や "apache "など、入力しやすく、使用するデータの種類を反映したシンプルな名前にする必要があります。

Defaultウェルは、他のウェルに明示的に割り当てられていないタグを持つすべてのエントリを受信します。 例えば、Syslogという名前のウェルに "syslog "と "apache "というタグが割り当てられている場合、他のすべてのタグはDefaultウェルに送られます。 インジェスターは、gravwell.confファイルで明示的に定義されていないタグ名を持つエントリーを作成することができます。そのエントリーは、デフォルトウェル内の他のすべての未割り当てタグと一緒に混在するだけです。

ウェル間でタグを再割り当てする場合、システムはデータを移動させません。 タグをデフォルト以外のウェルに固定せずに「syslog」タグでデータを取り込んだ後、設定ファイルを変更して新しいウェ ルを定義するか、syslogタグを既存のウェルに割り当てると、syslogタグの下のデフォルトウェルに存在するすべての データは検索不可能になります。 エントリを復元できるウェルおよびタグの移行用のスタンドアロンツールへのアクセス、または古いウェルを最適化/代替構成に再インストールするためのヘルプについては、support@ppln.co に連絡してください。

## データエージアウト

DatalaiQは、データ管理ポリシーを個々のウェルに適用することができるエージアウトシステムをサポートしています。 エージアウトポリシーは、データの保持、ストレージウェルの使用、圧縮を制御します。 データのエージアウトの設定に関する詳細は、[データエージアウト](ageout.md) セクションを参照してください。

## ウェルレプリケーション

複数のインデクサノードを持つDatalaiQクラスタでは、ディスク障害や偶発的な削除に備えて、ノード間でデータの複製を行うように設定することができます。レプリケーションの設定方法については、[レプリケーションドキュメント](replication.md) を参照してください。

## クエリアクセラレーション

DatalaiQは、個々のウェルに対して「アクセラレータ」という概念をサポートしており、インジェスト時にデータにパーサーを適用し、最適化ブロックを生成することができます。 アクセラレーターは、クエリーモジュールと同様に柔軟性があり、クエリーを実行する際に透過的に作動します。 Acceleratorsは、特定のフィールド値を持つデータに素早くアクセスする必要がある、needle-in-haystackスタイルのクエリに非常に有効です。 より詳細な情報と設定方法については、[アクセラレーター](accelerators.md) セクションを参照してください。

## パスワード複雑性

DatalaiQは、シングルサインオンモードでない場合に、ユーザーにパスワードの複雑さを強制するオプションをサポートしています。 パスワードの複雑さの要求を有効にするには、`gravwell.conf`ファイルに以下の構造を追加することで実行されます:


```
[Password-Controls]
	Min-Length=<integer>
	Require-Uppercase=<bool>
	Require-Lowercase=<bool>
	Require-Number=<bool>
	Require-Special=<bool>
```

また、DatalaiQ は安全な bcrypt パスワード・ハッシュ・システムを使用しているため、事後的にこれらのルールを強制する方法がありません。 パスワードの複雑性に関する要件を有効にすると、今後変更するすべてのパスワードは、この要件に従うことが要求されます。

以下は、10文字以上の複雑なパスワードを要求する設定ブロックの例です:

```
[Password-Controls]
	Min-Length=10
	Require-Uppercase=true
	Require-Lowercase=true
	Require-Number=true
	Require-Special=true

```

DatalaiQはUTF-8文字セットを完全にサポートしており、多くの言語には大文字小文字の概念がないことに注意してください。 したがって、パスワード `パスワード推測することはできません！#$@42` は非常に複雑に見えるかもしれませんが、大文字と小文字の値がないため、上記の要件を満たしません。

## バージョン互換性 

インデクサとウェブサーバの特定のバージョンは、他のインデクサとウェブサーバの特定のバージョンとしか互換性がありません。以下の表は、バージョンの互換性制限の詳細です。不一致のウェブサーバとインデクサは実行されません。

| API Version | Indexer/Webserver Version Compatibility |
|-------------|---------------|
| 1 | Any version between 1.0-3.3 |
| 2 | 4.0 and 4.1 |
| 3 | 4.2 |

インジェスターは、接続時にインジェストプロトコルのバージョンをネゴシエートするので、常に古いバージョンのインデクサーと後方互換性があります。しかし、バージョンの不一致が大きい場合、いくつかの新機能が無効になることがあります。お使いのインデクサーのバージョンと一致するインジェスターのバージョンを使用することをお勧めします。
