# 通知REST API
通知とは、1人または複数のユーザーに表示されるメッセージです。メッセージは、表示されるテキストを含むメッセージフィールドと、メッセージに関連するURLであるリンクフィールド（オプション）を含みます。

通知には、タイプも含めることができます。タイプは、何かが重複することなく継続的に通知を送ることができるように使用されます。例えば、ウェブサーバは、Type=0xDEADBEEFで`Indexer X is down`という通知を追加し続けることができます。 タイプは同じなので、通知エンジンは古い通知を更新し続けるでしょう。

通知には、ターゲットとブロードキャストの2つの形式があります。 ブロードキャスト通知はすべての人に送られ、ターゲット通知は適切なUIDまたはGIDを持つユーザーにのみ送られます。 ブロードキャスト通知は本質的にUID/GIDを持ちません(常にゼロです)。

備考: 管理者だけが、他のユーザーにも見える通知を作成できます。一般ユーザーは、自分自身にのみ表示される通知を作成することができます。

通知は、自動的に削除される日付を指定する、[期限]フィールドを持っています。また、Sentフィールドもあり、これは通常空白のままで、サーバーによって自動入力されます。また、オプションでIgnoreUntilフィールドがあります。将来のIgnoreUntil日付を持つ通知は、その時間までリクエストに応答しません。空白の日付（Sent, Expires, IgnoreUntil）を持つ通知が追加された場合、それらはデフォルト値で入力されます。

次のような通知を考えてみましょう:

```
{
    "Broadcast": false,
    "Expires": "2019-04-23T03:44:01.776918756-06:00",
    "GID": 0,
    "IgnoreUntil": "0001-01-01T00:00:00Z",
    "Msg": "foobar",
	"Link": "https://ppln.co",
    "Origin": "00000000-0000-0000-0000-000000000000",
    "Sender": 7,
    "Sent": "2019-04-22T21:44:01.776942432Z",
    "Type": 1,
    "UID": 7
}
```

この通知はUID 7のユーザーを対象としており、特定のグループを対象としていません。それは同じユーザーによって作成されました。それはTypeが'1'です。これはブロードキャスト通知ではありません。それは21:44 UTCに送られ、12時間後に期限切れとなる。メッセージは "foobar "で、https://ppln.co への関連したリンクを持っています。

通知を作成するとき、唯一の*本当に*必須フィールドはMsgです。ターゲット通知を作成する場合、GIDおよび/またはUIDも指定する必要があります。LinkとIgnoreUntilフィールドはオプションです。Broadcastフラグは、どのAPIエンドポイントが使用されるかによって、サーバーによって設定されます。

Origin "フィールドは、インデクサによって生成される自動通知に使用され、無視することができます。

すべての通知は刹那的です。 ウェブサーバやフロントエンドが再起動すると、それらは失われます。

すべての通知はIDを持ち、各IDは単調に増加し、常に10進数のuint64で表現されます。

基本的なREST APIのURLは以下の通りです:

```
/api/notifications
/api/notifications/all/{id:[0-9]+}
/api/notifications/{id:[0-9]+}
/api/notifications/broadcast
/api/notifications/targeted
/api/notifications/targeted/self
```

リクエストメソッド:

GET - プルバック通知
PUT - 特定の通知を更新する
POST - 新規通知を追加する
DELETE - 特定の通知を削除する

## 通知ルール

* 管理者だけが新しい通知を追加できます。ただし、`/api/notifications/targeted/self` apiを経由する場合は除きます。
* ユーザーは、自分が明示的に所有している（UIDが一致する）通知のみを更新することができます。
* ユーザーは、通知に関連するUIDまたはGIDを変更することはできません。
* ユーザーが所有していない通知を削除できません(UIDが一致しない)。

## 新しい通知を追加する

### ブロードキャスト通知とターゲット通知を追加する（管理者のみ）

管理者は Notification 構造体を `/api/notifications/broadcast` に POST してブロードキャスト通知を作成したり、 `/api/notifications/targeted` に POST してターゲット通知を作成したりすることができます。明示的なタイプを持つブロードキャスト通知を作成するには、次のようにPOSTします:

```
{
	"Msg": "This is a broadcast notification"
	"Type": 123
}
```

特定のグループにターゲットを絞った通知は、次のようになります:

```
{
	"Msg": "This is a targeted notification",
	"GID": 2
}
```

### セルフターゲット通知を追加する

非管理者ユーザーは `/api/notifications/targeted/self` への POST で通知を作成することができます。Type、Msg、Expiresフィールドのみが尊重されることに注意してください。これらの通知の有効期限はデフォルトで12時間です。Expiresフィールドが過去または24時間以上先の場合、現在の時刻から12時間後に設定されます。

```
{
	"Msg": "This is a self-targeted notification"
}
```

## 通知を取得する

ユーザーは `/api/notifications` へのGETリクエストですべてのnotificationを取得することができます。 特定のnotification ID以降に作成されたすべてのnotificationを取得するには、/api/notifications/{id}にGETを発行します。 例えば、0から10までのnotificationを見たことがある場合、/api/notifications/10をリクエストすると、そのユーザーがアクセスできる新しいnotificationだけを取得することができます。

### 全通知を取得する（管理者のみ）

管理者は `/api/notifications/all/` でGETすることで、UIDやGIDに関係なくすべての通知を取得することができます。

## 通知を更新する

通知を更新するには、該当する通知に対して `/api/notifications/{id}` でPUTリクエストを行います。

## 通知を削除する

通知を削除するには、特定の通知IDに対して `/api/notifications/{id}` にDELETEリクエストを送信してください。管理者でないユーザーは、自分のUIDをターゲットにした通知だけを削除することができることに注意してください。
