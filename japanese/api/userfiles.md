# ユーザーファイルAPI

ユーザーファイルAPIは、キットがアイコンなどに使用する小さなファイルを保存できるように設計されています。

ユーザーファイルはGUIDで参照されます。GUIDはシステム全体で必ずしも一意ではありません。これにより、例えばダッシュボードではGUIDで特定のファイルを参照しながら、各ユーザーは自分の好みのファイルをインストールすることができます。同じGUIDで複数のファイルが存在する場合、以下の順序で優先されます:

* ユーザーに所有されているユーザーファイル
* グループのメンバーに共有されているユーザーファイル
* グローバルに公開されているユーザーファイル

 各ファイルは、DatalaiQが保管のために使用するユニークなUUIDを持っています。以下に説明する管理者APIにより、管理者はその「ThingUUID」を参照しながらユーザーファイルを管理することができます。

## ユーザーファイルを作成する

ユーザーファイルは `/api/files` への POST リクエストで作成することができます。リクエストは2つのフォーマットのうちの1つであるマルチパートリクエストでなければならない。

### 簡易ファイル作成リクエストフォーマット

以下のフィールドを指定して、`/api/files` に POST リクエストを送信します:

* `file`: ファイル本文
* `name`: ファイル名
* `desc`: ファイル詳細
* `guid`: (任意) このファイルに必要なGUIDを指定します。設定されていない場合は、1つのGUIDが生成されます。

### 詳細ファイル作成リクエストフォーマット

以下のフィールドを指定して、`/api/files` に POST リクエストを送信します:

* `file`: ファイル本文
* `meta`: 以下のような、希望する所有権と共有の詳細を記述するJSONエンコードされた構造体です。

meta "フィールドは、共有と所有権を記述するJSONエンコードされた文字列である必要があります:

```
{
	"UID": 1,
	"GIDs": [2],
	"Global": false,
	"Name": "blah",
	"Desc": "bar",
	"Labels": ["foo"],
}
```

備考: 管理者のみがUIDフィールドを他のユーザーのUIDに設定したり、Globalフィールドをtrueに設定したりすることができます。


## ファイルズファイルをリスト表示する

ユーザーファイルは `/api/files` に対する GET でリストアップすることができる。結果は、ファイル情報を含む構造体の配列となります:

```
[
	{
		"GUID": "1945c39e-0bd1-40cf-b069-6da64d3f8afe",
		"ThingUUID": "3525901f-5723-11e9-be65-54e1ad7c66cf",
		"UID": 1,
		"GIDs": null,
		"Global": false,
		"Size": 99,
		"Type": "text/plain; charset=utf-8",
		"Name": "blah",
		"Desc": "bar",
		"Labels": ["foo"],
		"Updated": "2019-04-04T15:50:19.290186504-06:00"
	}
]
```

## ファイル本文を読み出す

ファイルの内容は `/api/files/<uuid>` へのGETリクエストで読み取ることができます。例えば、上記のリストにある `/api/files/1945c39e-0bd1-40cf-b069-6da64d3f8afe` のファイルを読み取るには、このようにします。

## ファイルを更新する

ファイルの内容は `/api/files/<uuid>` への POST リクエストで変更することができます。このリクエストは新しいファイルを作成する場合と同じですが、`file` フィールドだけが尊重されます。他のフィールドを変更するには、以下を参照してください。

## ファイルのメタデータを更新する

ファイルの様々なフィールド(Name, Desc, Global, GID, Labels)は `/api/files/<uuid>` への PATCH リクエストで更新することができます。リクエストのボディは、リスト (GET `/api/files`) で返されたものと同じ構造である必要があります:

```
{
	"UID": 1,
	"GIDs": null,
	"Global": false,
	"Name": "blah",
	"Desc": "bar",
	"Labels": ["foo"],
}
```

上記以外のフィールドが存在しても無視されることに注意。

注意: ファイルのUIDは変更することができますが、それは管理者のみで、`?admin=true`パラメータが設定されているときだけです。

## ファイルを削除する

ユーザーファイルは `/api/files/<uuid>` の DELETE で削除することができます。

## 管理者操作

管理者ユーザーは、システム上のすべてのユーザー・ファイルを表示したり、変更したり、削除したりする必要がある場合があります。GUIDは必ずしも一意ではないため、管理者APIは代わりにDatalaiQがアイテムの保存に内部的に使用している一意のUUIDを参照する必要があります。上記のサンプル・ファイルのリストには、"ThingUUID "という名前のフィールドが含まれていることに注意してください。これは、そのユーザー・ファイルに対する内部的で一意な識別子です。

管理者ユーザーは、`/api/files?admin=true`のGETリクエストで、システム内のすべてのユーザーファイルのグローバルリストを取得することができます。

管理者は、`/api/files/<ThingUUID>?admin=true`へのDELETEメッセージで、希望するファイルのThingUUID値を代入して、特定のファイルを削除することができます。同じパターンが更新にも適用されます。