# 検索制御

REST API located at /api/searchctrl

searchctrlグループは、永続的な検索に関する情報を照会し、オプションで何らかのアクションを実行するために使用されます。 現在、すべてのアクティブな検索を問い合わせる機能、特定の検索に関する情報を取得する機能、アクティブな検索をバックグラウンドにする機能、アクティブな検索をアーカイブする機能、検索を削除/終了する機能を提供しています。

## 基本API

ここでの基本的な動作は、REST urlに対してGET、DELETE、またはPATCHを実行することです。

## 検索状態

検索は以下のいずれかの状態にすることができ、同時に複数の状態（ACTIVE/BACKGROUNDED、SAVED/ATTACHED、DORMANT/SAVEDなど）にもすることができます。

- Active: 検索が実行中または終了しており、それに付随するセッションが存在する。
- Backgrounded: 検索はアクティブに実行されますが、セッションが接続されていない状態で持続するようにマークされています。
- Saving: 検索は保存されましたが、その内容を永続的な場所に移動するための完了を待っている状態です。
- Saved: 検索結果は保存され、適切な永続的な場所に移動されます。
- Dormant: 検索が保持されている（バックグラウンドまたは保存されている）、セッションが添付されていない。
- Attached: 検索が保存され、セッションが再付加されました。

## 検索のリストを取得する
検索リストをリクエストすると、ウェブサーバは現在のユーザが閲覧することが許可されているすべての検索を返します。 jsonパッケージは投稿されず、'/api/searchctrl'に対して空のGETが実行されます。 

```
[
        {
                "ID": "181382061",
                "UID": 1,
                "GID": 0,
                "State": "ACTIVE",
                "AttachedClients": 1
        },
        {
                "ID": "010985768",
                "UID": 1,
                "GID": 0,
                "State": "BACKGROUNDED",
                "AttachedClients": 0
        },
        {
                "ID": "795927171",
                "UID": 1,
                "GID": 0,
                "State": "DORMANT",
                "AttachedClients": 0
        }
]
```

## 特定の検索の情報を取得する
特定の検索の状態を取得するには、REST url /api/searchctrl/:ID を GET してください。

```
WEB GET /api/searchctrl/795927171:
[
	{
		"ID": "795927171",
		"UID": 1,
		"UserQuery": "grep paco | grep chico",
		"EffectiveQuery": "grep paco | grep chico | text",
		"StartRange": "2016-12-22T12:41:27.011080417-07:00",
		"EndRange": "2016-12-22T13:01:27.011080417-07:00",
		"Started": "2016-12-22T13:01:27.01227455-07:00",
		"Finished": "0001-01-01T00:00:00Z",
		"StoreSize": 0,
		"IndexSize": 0
	}
]
```

## バックグラウンド検索

検索のバックグラウンド化は、最後のクライアントが離脱した場合、その検索を継続しても良いことをウェブサーバーに通知するために使用されます。 検索をバックグラウンドにするには、/api/searchctrl/:ID/background correct IDというURLにPATCHを実行してください。  このコマンドを成功させるには、検索がアクティブであるか、すでにバックグラウンドになっていなければならず、ユーザーは管理者であるか、検索へのアクセス権を持っていなければなりません。

```
WEB PATCH /api/searchctrl/795927171/background:
null
```

## 検索の保存

検索の保存は、ウェブサーバーにこの検索結果を保持したいことを伝えるために使用されます。 バックグラウンド検索は、ウェブサーバーがディスクスペースを必要としない限り（または明示的に削除されない限り）、（誰も接続していなくても）常駐し続けます。 保存すると、結果は保存された場所に移動し、（適切な権限を持つ）誰かが明示的に要求しない限り、結果は削除されません。 検索結果を保存するには、/api/searchctrl/:ID/save correct IDというURLにPATCHを実行します。  検索はどのような状態でも保存できますが、休止状態になると、永続的なストレージに転送されます。 永続的ストレージへの転送は、（永続的ストレージが同じドライブにある場合は）瞬時に行われますが、完全なコピーが必要な場合もあります。 これはバックグラウンドで独自のゴルーチンで行われるため、その間にブロックされることはありません。

メタデータは有効なJSON構造である必要があります。 このメタデータはメモや情報など、JSONブロブとしてエンコードできるものであれば何でも添付することができます。 メタデータは検索を保存するための `PATCH` リクエストの本文にエンコードされなければなりません。

```
WEB PATCH /api/searchctrl/10985768/save:
null
```

## 検索を削除/終了する

検索を削除すると、検索が終了し（アクティブなユーザーを追い出し）、検索結果に関連付けられたストレージが直ちに削除されます。 検索はどのような状態でも削除することができます。 検索を削除するには、正しいIDを指定して/api/searchctrl/:IDにDELETEリクエストを実行します。 サーバーは成功した場合は200、エラーの場合は5XX、ユーザーが検索を変更する権限がない場合は403を返します。

```
WEB DELETE /api/searchctrl/010985768:
null
```

## アクティブな検索を停止する

検索を停止すると、インデクサは検索パイプラインへの新しいデータの供給を停止しますが、すでに処理された既存のデータは維持され、ユーザーは出力とのやりとりを続けることができます。検索を停止させることができるのは、それがアクティブな実行状態にあるときだけで、保存されている検索や休止状態の検索は、停止コマンドを発行するとエラーで応答します。検索を停止するには、正しいIDを指定して/api/searchctrl/ID/stopにPUTリクエストを実行してください。サーバーは成功した場合は200、エラーの場合は5XX、ユーザーが検索を変更する権限がない場合は403を返します。 検索の所有者または管理者のみがアクティブな検索を停止することができ、共有グループのユーザは所有していない検索を停止することはできません。 共有グループのユーザーは、自分が所有していない検索を停止することはできません。停止コマンドを実行した後でも、検索結果を保存することができます。

```
WEB PUT /api/searchctrl/010985768/stop:
null
```

## 保存した検索をインポートする

検索結果のダウンロード形式として、オプションで `archive` を使用することができます。 アーカイブは完全に自己完結した検索を表し、別のDatalaiQインスタンスにインポートすることができる。 インポートAPIは、保存された検索アーカイブをアップロードとして受け入れ、検索を保存された検索システムに解凍します。 ユーザーは、ローカル・システムに保存されているのと同じように、検索に添付することができます。

検索アーカイブが再インポートされると、インポートされた検索は、どのユーザーがダウンロードしたかにかかわらず、インポートしたユーザーが所有することになります。 インポートされた検索をグループで共有するために、オプションの `GID` フォームフィールドをインポートリクエストで提供することができます。

検索結果は `/api/searchctrl/import` URL にマルチパートフォーム `POST` を実行することでインポートされます。

APIは、ファイルアップロードが`file`というフォームフィールドに行われることを想定しています。

インポートAPIは、JWT認証トークンまたはCookieを使用して認証することができます。

備考: 管理者は `GID` フォームフィールドに自分が属していないグループを指定することができますが、管理者以外のユーザーは `GID` で指定されたグループのメンバーである必要があります。

## 管理者API

管理者ユーザーは、上記のAPIエンドポイントを使用して、検索に関する情報の取得、検索の削除、検索の読み込み、検索のバックグラウンドへの送信などを行うことができます。

### 全ての検索をリスト表示する

システム上に存在するすべての検索のリストを取得するために、管理者ユーザは `/api/searchctrl/all` を GET してください。フォーマットは `/api/searchctrl` から返されるものと同じですが、システム上にあるすべての検索結果が含まれます。

```
[
    {
        "AttachedClients": 0,
        "GID": 0,
        "ID": "486574780",
        "State": "DORMANT",
        "StoredData": 9355,
        "UID": 1
    },
    {
        "AttachedClients": 0,
        "GID": 0,
        "ID": "815623546",
        "State": "DORMANT",
        "StoredData": 3536,
        "UID": 4
    },
    {
        "AttachedClients": 0,
        "GID": 0,
        "ID": "525125903",
        "State": "DORMANT",
        "StoredData": 0,
        "UID": 7
    },
    {
        "AttachedClients": 0,
        "GID": 0,
        "ID": "274379984",
        "State": "DORMANT",
        "StoredData": 319,
        "UID": 4
    }
]

```
